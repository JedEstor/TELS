<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>

  {% load humanize %}
  {% load customer_filters %}
</head>

<body class="min-h-screen bg-slate-100 text-slate-900">

  {% if tab == "forecast" %}
  <!-- Forecast Records Section -->
  <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
    <div class="px-5 py-4 border-b border-slate-200 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div>
        <h2 class="text-lg font-semibold text-slate-900">Forecast Records</h2>
      </div>
      
      <div class="flex items-center gap-2">
        <span class="text-sm text-slate-600">Total: <span class="font-semibold text-slate-900">{{ forecasts_total }}</span></span>
      </div>
    </div>

        <div class="px-5 py-3 border-b border-slate-200">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex flex-wrap gap-2 items-center">
          <form method="get" class="flex gap-2">
            <input type="hidden" name="tab" value="forecast">
            <select name="fcustomer" 
                    class="h-10 px-3 rounded-xl border border-slate-300 bg-white text-sm text-slate-700
                           focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">All Customers</option>
              {% for customer in all_customers %}
                <option value="{{ customer.customer_name }}" {% if fcustomer == customer.customer_name %}selected{% endif %}>
                  {{ customer.customer_name }}
                </option>
              {% endfor %}
            </select>
            <input
              type="text"
              name="fq"
              value="{{ fq|default:'' }}"
              placeholder="Search part number / part name..."
              class="h-10 w-80 max-w-full px-3 rounded-xl bg-white border border-slate-300 text-slate-900
                     focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <button class="h-10 px-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white" type="submit">
              Search
            </button>
            <a href="?tab=forecast" 
               class="h-10 px-4 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-600 text-sm flex items-center">
              Reset
            </a>
          </form>
        </div>
        
        <div class="flex flex-wrap gap-2 items-center justify-end">
          <button type="button"
                  id="open-forecast-csv"
                  class="h-10 px-4 rounded-xl bg-slate-900 hover:bg-slate-800 text-white whitespace-nowrap">
            CSV Upload
          </button>
          <a href="#"
             id="open-forecast-form"
             class="h-10 px-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white whitespace-nowrap flex items-center justify-center">
            + Add Forecast
          </a>
        </div>
      </div>
    </div>
    <div>
      <table class="w-full text-sm">
        <thead class="bg-slate-50 text-slate-700">
          <tr>
            <th class="px-4 py-3 text-left">Customer</th>
            <th class="px-4 py-3 text-left">Part Number</th>
            <th class="px-4 py-3 text-left">Part Name</th>
            <th class="px-4 py-3 text-left">Unit Price</th>
            <th class="px-4 py-3 text-left">Months</th>
            <th class="px-4 py-3 text-left">Quantity</th>
            <th class="px-4 py-3 text-right">Action</th>
          </tr>
        </thead>

        <tbody>
          {% for forecast in forecasts_list %}
          <tr class="border-t border-slate-200 hover:bg-slate-50">
            <td class="px-4 py-3 font-medium">{{ forecast.customer.customer_name }}</td>
            <td class="px-4 py-3">{{ forecast.part_number }}</td>
            <td class="px-4 py-3">{{ forecast.part_name }}</td>
            <td class="px-4 py-3">{{ forecast.unit_price_display|floatformat:5 }}</td>
            <td class="px-4 py-3">
              {% with monthly=forecast.monthly_forecasts %}
                {% if monthly %}
                  {% for m in monthly %}
                    {% if forloop.counter <= 2 %}
                      {{ m.date }}<br>
                    {% endif %}
                  {% endfor %}
                  {% if monthly|length > 2 %}
                    <span class="text-xs text-slate-500">+{{ monthly|length|add:"-2" }} more</span>
                  {% endif %}
                {% else %}
                  —
                {% endif %}
              {% endwith %}
            </td>
            <td class="px-4 py-3">{{ forecast.quantity_display|floatformat:0|intcomma }}</td>
                        <td class="px-4 py-3 text-right">
              <div class="inline-flex items-center gap-2">
                <a href="#" 
   class="edit-forecast-btn px-3 py-2 rounded-xl border border-slate-200 bg-white-600 hover:bg-blue-500 text-black inline-block"
   data-customer="{{ forecast.customer.customer_name }}"
   data-part-number="{{ forecast.part_number }}"
   data-part-name="{{ forecast.part_name }}"
   data-unit-price="{{ forecast.unit_price_display }}"
   data-quantity="{{ forecast.quantity_display }}"
   data-monthly='{{ forecast.monthly_forecasts|safe }}'>
  Edit
</a>
                <form method="post" action="{% url 'app:admin_dashboard' %}" class="inline" 
                      onsubmit="return confirm('Are you sure you want to delete this forecast for {{ forecast.customer.customer_name }} - {{ forecast.part_number }}?');">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="delete_forecast">
                  <input type="hidden" name="customer_name" value="{{ forecast.customer.customer_name }}">
                  <input type="hidden" name="part_number" value="{{ forecast.part_number }}">
                  <button type="submit" 
                          class="px-3 py-2 rounded-xl bg-rose-600 hover:bg-rose-500 text-white">
                    Delete
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="px-4 py-10 text-center text-slate-500">
              No forecast records found. Click "+ Add Forecast" to create one.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <!-- Add Pagination Here -->
    {% if forecasts_list.paginator.num_pages > 1 %}
    <div class="px-5 py-4 border-t border-slate-200 flex items-center justify-between">
      <div class="text-sm text-slate-600">
        Showing <span class="font-semibold">{{ forecasts_list.start_index }}</span> 
        - <span class="font-semibold">{{ forecasts_list.end_index }}</span> 
        of <span class="font-semibold">{{ forecasts_total }}</span>
      </div>
      <div class="flex items-center gap-1">
        {% if forecasts_list.has_previous %}
        <a href="?tab=forecast&page={{ forecasts_list.previous_page_number }}{% if fcustomer %}&fcustomer={{ fcustomer }}{% endif %}{% if fq %}&fq={{ fq }}{% endif %}" 
           class="px-3 py-1 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-slate-600 text-sm">
          ← Prev
        </a>
        {% else %}
        <span class="px-3 py-1 rounded-lg border border-slate-200 bg-slate-50 text-slate-400 text-sm cursor-not-allowed">
          ← Prev
        </span>
        {% endif %}
        
        {% for num in forecasts_list.paginator.page_range %}
          {% if num == forecasts_list.number %}
            <span class="px-3 py-1 rounded-lg bg-blue-600 text-white text-sm font-semibold">{{ num }}</span>
          {% elif num > forecasts_list.number|add:'-3' and num < forecasts_list.number|add:'3' %}
            <a href="?tab=forecast&page={{ num }}{% if fcustomer %}&fcustomer={{ fcustomer }}{% endif %}{% if fq %}&fq={{ fq }}{% endif %}" 
               class="px-3 py-1 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-slate-600 text-sm">
              {{ num }}
            </a>
          {% endif %}
        {% endfor %}
        
        {% if forecasts_list.has_next %}
        <a href="?tab=forecast&page={{ forecasts_list.next_page_number }}{% if fcustomer %}&fcustomer={{ fcustomer }}{% endif %}{% if fq %}&fq={{ fq }}{% endif %}" 
           class="px-3 py-1 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-slate-600 text-sm">
          Next →
        </a>
        {% else %}
        <span class="px-3 py-1 rounded-lg border border-slate-200 bg-slate-50 text-slate-400 text-sm cursor-not-allowed">
          Next →
        </span>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  {% if tab == "forecast_summary" %}
  <!-- Forecast Summary Section -->
  <div class="space-y-5">
    <!-- Header bar -->
    <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div>
        <h2 class="text-lg font-semibold text-slate-900">Forecast Summary</h2>
        <p class="text-sm text-slate-500">Previous year vs. current year forecast by part number</p>
      </div>

      <!-- Filter bar -->
      <form method="get" class="flex flex-wrap gap-2 items-center">
        <input type="hidden" name="tab" value="forecast_summary">
        <select name="fsq_customer"
                class="h-10 px-3 rounded-xl border border-slate-300 bg-white text-sm text-slate-700
                       focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">All Customers</option>
          {% for c in fs_customers %}
            <option value="{{ c }}" {% if fsq_customer == c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
        <input type="text" name="fsq" value="{{ fsq|default:'' }}"
               placeholder="Search part number / name…"
               class="h-10 px-3 w-60 rounded-xl border border-slate-300 bg-white text-sm text-slate-700
                      focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button type="submit"
                class="h-10 px-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white text-sm">
          Filter
        </button>
        <a href="?tab=forecast_summary"
           class="h-10 px-4 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-600 text-sm flex items-center">
          Reset
        </a>
      </form>
    </div>

    <!-- Table -->
    <div class="fs-table-wrap">
      <table class="fs-table">
        <thead>
          <!-- Row 1: Main headers with PREVIOUS FORECAST and FORECAST side by side -->
          <tr>
            <!-- Fixed left columns (no colspan) -->
            <th class="fs-col-header sticky-left" style="min-width:140px; padding: 8px 6px;">CUSTOMER</th>
            <th class="fs-col-header sticky-left" style="min-width:130px; left:140px; padding: 8px 6px;">PART NUMBER</th>
            <th class="fs-col-header" style="min-width:140px; padding: 8px 6px;">PART NAME</th>
            <th class="fs-col-header" style="min-width:70px; padding: 8px 6px;">UNIT PRICE</th>

            <!-- PREVIOUS FORECAST header -->
            <th class="fs-section-prev section-border-left" colspan="{{ fs_prev_months|length }}" style="padding: 8px 4px;">
              PREVIOUS FORECAST ({{ fs_prev_year|default:"Previous Year" }})
            </th>

            <!-- FORECAST header -->
            <th class="fs-section-fore section-border-left" colspan="{{ fs_fore_months|length }}" style="padding: 8px 4px;">
              FORECAST ({{ fs_fore_year|default:"Current Year" }})
            </th>
          </tr>

          <!-- Row 2: Month columns -->
          <tr>
            <!-- Fixed left columns (empty cells for alignment) -->
            <th class="fs-col-header sticky-left" style="padding: 6px 4px;"></th>
            <th class="fs-col-header sticky-left" style="padding: 6px 4px;"></th>
            <th class="fs-col-header" style="padding: 6px 4px;"></th>
            <th class="fs-col-header" style="padding: 6px 4px;"></th>

            <!-- Previous Forecast Months (JAN–DEC) -->
            {% for month in fs_prev_months %}
              <th
                class="fs-col-header prev-month {% if forloop.first %}section-border-left{% endif %}"
                style="padding: 6px 4px; min-width:45px;"
              >
                {{ month }}
              </th>
            {% endfor %}

            <!-- Forecast Months (JAN–DEC) -->
            {% for month in fs_fore_months %}
              <th
                class="fs-col-header fore-month {% if forloop.first %}section-border-left{% endif %}"
                style="padding: 6px 4px; min-width:45px;"
              >
                {{ month }}
              </th>
            {% endfor %}
          </tr>
        </thead>

        <tbody>
          {% for row in fs_rows %}
          <tr class="data-row">
            <td class="sticky-left" style="left:0; padding: 8px 6px; text-align: left;">{{ row.customer }}</td>
            <td class="sticky-left font-mono" style="left:140px; padding: 8px 6px; text-align: left;">{{ row.part_number }}</td>
            <td style="padding: 8px 6px; text-align: left;">{{ row.part_name }}</td>
            <td style="padding: 8px 6px; text-align: right;">{{ row.unit_price|floatformat:4 }}</td>

            <!-- Previous Forecast Months (JAN–DEC) -->
            {% for month in fs_prev_months %}
              <td class="{% if forloop.first %}section-border-left{% endif %}" style="padding: 8px 4px; text-align: center;">
                {% with val=row.prev|get_item:month %}
                  {% if val %}{{ val|floatformat:0|intcomma }}{% else %}-{% endif %}
                {% endwith %}
              </td>
            {% endfor %}

            <!-- Forecast Months (JAN–DEC) -->
            {% for month in fs_fore_months %}
              <td class="{% if forloop.first %}section-border-left{% endif %}" style="padding: 8px 4px; text-align: center;">
                {% with val=row.fore|get_item:month %}
                  {% if val %}{{ val|floatformat:0|intcomma }}{% else %}0{% endif %}
                {% endwith %}
              </td>
            {% endfor %}
          </tr>
          {% empty %}
          <tr>
            <td colspan="16" class="px-6 py-12 text-center text-slate-400 text-sm">
              No forecast records found.
            </td>
          </tr>
          {% endfor %}

          <!-- TOTAL QTY row -->
          {% if fs_rows %}
          <tr class="total-row">
            <td class="sticky-left" style="left:0;"></td>
            <td class="sticky-left" style="left:140px;"></td>
            <td class="text-left font-bold text-slate-700" style="padding: 8px 6px;">TOTAL QTY</td>
            <td></td>

            <!-- Previous Forecast Totals -->
            {% for month in fs_prev_months %}
              <td class="{% if forloop.first %}section-border-left{% endif %}" style="padding: 8px 4px; text-align: center;">
                {{ fs_total_prev_qty|get_item:month|default:"—"|intcomma }}
              </td>
            {% endfor %}

            <!-- Forecast Totals -->
            {% for month in fs_fore_months %}
              <td class="{% if forloop.first %}section-border-left{% endif %}" style="padding: 8px 4px; text-align: center;">
                {{ fs_total_fore_qty|get_item:month|default:"—"|intcomma }}
              </td>
            {% endfor %}
          </tr>

          <!-- TOTAL AMOUNT row -->
          <tr class="total-amount-row">
            <td class="sticky-left" style="left:0;"></td>
            <td class="sticky-left" style="left:140px;"></td>
            <td class="text-left font-bold text-slate-700" style="padding: 8px 6px;">TOTAL AMOUNT</td>
            <td></td>

            <!-- Previous Forecast Amounts -->
            {% for month in fs_prev_months %}
              <td class="{% if forloop.first %}section-border-left{% endif %}" style="padding: 8px 4px; text-align: center;">
                {{ fs_total_prev_amt|get_item:month|default:"—"|floatformat:0|intcomma }}
              </td>
            {% endfor %}

            <!-- Forecast Amounts -->
            {% for month in fs_fore_months %}
              <td class="{% if forloop.first %}section-border-left{% endif %}" style="padding: 8px 4px; text-align: center;">
                {{ fs_total_fore_amt|get_item:month|default:"—"|floatformat:0|intcomma }}
              </td>
            {% endfor %}
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    
  </div>
  {% endif %}

  <!-- Edit Forecast Panel -->
  <div id="edit-forecast-backdrop" class="hidden fixed inset-0 bg-black/50 z-40"></div>

  <div id="edit-forecast-panel"
       class="fixed top-0 right-0 h-full w-full sm:w-[500px]
              bg-white text-slate-900 border-l border-slate-200 z-50
              translate-x-full transition-transform duration-200 flex flex-col">

    <div class="p-4 border-b border-slate-200 flex justify-between items-center">
      <div>
        <div class="font-semibold text-blue-700">Edit Forecast</div>
        <div class="text-xs text-slate-500">Update forecast record</div>
      </div>
      <button id="edit-forecast-close"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 border border-slate-200">
        Close
      </button>
    </div>

    <div id="edit-forecast-content" class="flex-1 overflow-y-auto p-6">
      <form method="post" action="{% url 'app:admin_dashboard' %}" class="space-y-5" id="edit-forecast-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_forecast">
        <input type="hidden" name="original_customer_name" id="edit-original-customer" value="">
        <input type="hidden" name="original_part_number" id="edit-original-part-number" value="">

        <div>
          <label class="text-sm font-medium text-slate-700">Customer Name</label>
          <input type="text" name="customer_name" id="edit-customer-name" required
                 class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 bg-white
                        focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                 placeholder="Enter customer name">
        </div>

        <div>
          <label class="text-sm font-medium text-slate-700">Part Name</label>
          <input type="text" name="part_name" id="edit-part-name" required
                 class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 bg-white
                        focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                 placeholder="Enter part name">
        </div>

        <div>
          <label class="text-sm font-medium text-slate-700">Part Number</label>
          <input type="text" name="part_number" id="edit-part-number" required
                 class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 bg-white
                        focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                 placeholder="Enter part number">
        </div>

        <div>
          <label class="text-sm font-medium text-slate-700">Month/Year</label>
          <div class="grid grid-cols-2 gap-3">
            <select name="month" id="edit-month"
                    class="px-3 py-2 rounded-xl border border-slate-300 bg-white
                           focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">Keep existing month</option>
              <option value="January">January</option>
              <option value="February">February</option>
              <option value="March">March</option>
              <option value="April">April</option>
              <option value="May">May</option>
              <option value="June">June</option>
              <option value="July">July</option>
              <option value="August">August</option>
              <option value="September">September</option>
              <option value="October">October</option>
              <option value="November">November</option>
              <option value="December">December</option>
            </select>
            <select name="year" id="edit-year"
                    class="px-3 py-2 rounded-xl border border-slate-300 bg-white
                           focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">Keep existing year</option>
              <option value="2024">2024</option>
              <option value="2025">2025</option>
              <option value="2026">2026</option>
              <option value="2027">2027</option>
              <option value="2028">2028</option>
            </select>
          </div>
        </div>

        <div>
          <label class="text-sm font-medium text-slate-700">Unit Price</label>
          <input type="number" name="unit_price" id="edit-unit-price" step="any" min="0" required
                 class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 bg-white
                        focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                 placeholder="0.00">
        </div>

        <div>
          <label class="text-sm font-medium text-slate-700">Quantity</label>
          <input type="number" name="quantity" id="edit-quantity" min="1" required
                 class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 bg-white
                        focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                 placeholder="Enter quantity">
        </div>

        <div class="pt-4 border-t border-slate-200 flex justify-end gap-2">
          <button type="button" id="edit-forecast-cancel"
                  class="px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50">
            Cancel
          </button>
          <button type="submit"
                  class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-500 text-white">
            Update Forecast
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Edit Forecast Panel JavaScript
    const editForecastBackdrop = document.getElementById("edit-forecast-backdrop");
    const editForecastPanel = document.getElementById("edit-forecast-panel");
    const editForecastClose = document.getElementById("edit-forecast-close");
    const editForecastCancel = document.getElementById("edit-forecast-cancel");

    function decodeUnicode(str) {
      if (!str) return '';
      return str.replace(/\\u([\dA-Fa-f]{4})/g, function(match, grp) {
        return String.fromCharCode(parseInt(grp, 16));
      });
    }

    function openEditForecastPanel() {
      if (!editForecastPanel || !editForecastBackdrop) {
        console.error("Edit forecast panel elements not found");
        return;
      }
      console.log("Opening edit panel");
      editForecastPanel.classList.remove("translate-x-full");
      editForecastBackdrop.classList.remove("hidden");
    }

    function closeEditForecastPanel() {
      if (!editForecastPanel || !editForecastBackdrop) return;
      editForecastPanel.classList.add("translate-x-full");
      editForecastBackdrop.classList.add("hidden");
      
      // Clear form fields
      document.getElementById("edit-customer-name").value = "";
      document.getElementById("edit-part-name").value = "";
      document.getElementById("edit-part-number").value = "";
      document.getElementById("edit-month").value = "";
      document.getElementById("edit-year").value = "";
      document.getElementById("edit-unit-price").value = "";
      document.getElementById("edit-quantity").value = "";
      document.getElementById("edit-original-customer").value = "";
      document.getElementById("edit-original-part-number").value = "";
    }

        function fillEditForm(data) {
      console.log("Filling edit form with data:", data);
      
      document.getElementById("edit-customer-name").value = decodeUnicode(data.customer);
      document.getElementById("edit-part-name").value = decodeUnicode(data.part_name);
      document.getElementById("edit-part-number").value = decodeUnicode(data.part_number);
      document.getElementById("edit-original-customer").value = decodeUnicode(data.original_customer || data.customer);
      document.getElementById("edit-original-part-number").value = decodeUnicode(data.original_part_number || data.part_number);
      
      // Set unit price and quantity from the data attributes
      document.getElementById("edit-unit-price").value = data.unit_price || 0;
      document.getElementById("edit-quantity").value = data.quantity || 0;
      
      // Reset month and year to empty first
      document.getElementById("edit-month").value = "";
      document.getElementById("edit-year").value = "";
      
      // Parse monthly forecasts for date information
      if (data.monthly && data.monthly.length > 0) {
        const firstMonth = data.monthly[0];
        
        // Parse date if it exists
        if (firstMonth.date) {
          const dateStr = firstMonth.date.trim();
          console.log("Parsing date:", dateStr);
          
          // Handle different date formats
          let month = '';
          let year = '';
          
          // Check for hyphen (expected format: "Month-YYYY")
          if (dateStr.includes('-')) {
            const parts = dateStr.split('-');
            month = parts[0].trim();
            year = parts[1]?.trim() || '';
          } 
          // Check for space
          else if (dateStr.includes(' ')) {
            const parts = dateStr.split(' ');
            month = parts[0].trim();
            year = parts[1]?.trim() || '';
          }
          // Check for slash
          else if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            month = parts[0].trim();
            year = parts[1]?.trim() || '';
          }
          
          if (month && year) {
            console.log("Extracted month:", month, "year:", year);
            
            // Convert month abbreviations to full names
            const monthMap = {
              'jan': 'January', 'feb': 'February', 'mar': 'March', 'apr': 'April',
              'may': 'May', 'jun': 'June', 'jul': 'July', 'aug': 'August',
              'sep': 'September', 'oct': 'October', 'nov': 'November', 'dec': 'December'
            };
            
            // If month is a number (like "2"), convert to month name
            if (!isNaN(month)) {
              const monthNum = parseInt(month, 10);
              if (monthNum >= 1 && monthNum <= 12) {
                const monthNames = ['January','February','March','April','May','June',
                                   'July','August','September','October','November','December'];
                month = monthNames[monthNum - 1];
              }
            } else {
              // Check for abbreviation
              const monthLower = month.toLowerCase().substring(0, 3);
              if (monthMap[monthLower]) {
                month = monthMap[monthLower];
              }
            }
            
            console.log("Final month:", month);
            
            // Set the month select
            const monthSelect = document.getElementById("edit-month");
            const monthOptions = Array.from(monthSelect.options).map(opt => opt.value);
            if (monthOptions.includes(month)) {
              monthSelect.value = month;
            } else {
              // If not found, set to empty (keep existing)
              monthSelect.value = "";
            }
            
            // Set year
            document.getElementById("edit-year").value = year;
          }
        }
      }
    }

    // Attach event listeners to edit buttons
    function attachEditButtonListeners() {
      const editForecastBtns = document.querySelectorAll(".edit-forecast-btn");
      console.log("Found", editForecastBtns.length, "edit buttons");
      
      if (editForecastBtns.length > 0) {
        editForecastBtns.forEach(btn => {
          // Remove any existing listeners to avoid duplicates
          btn.removeEventListener("click", handleEditClick);
          btn.addEventListener("click", handleEditClick);
        });
      }
    }

    function handleEditClick(e) {
      e.preventDefault();
      console.log("Edit button clicked");
      
      const btn = e.currentTarget;
      
      // Get data from button attributes
      const customer = btn.dataset.customer;
      const partNumber = btn.dataset.partNumber;
      const partName = btn.dataset.partName;
      const unitPrice = btn.dataset.unitPrice;
      const quantity = btn.dataset.quantity;
      let monthly = [];
      
      try {
        monthly = JSON.parse(btn.dataset.monthly || '[]');
        console.log("Parsed monthly data:", monthly);
      } catch (e) {
        console.error("Error parsing monthly data", e);
      }
      
      // Fill the form
      fillEditForm({
        customer: customer,
        part_number: partNumber,
        part_name: partName,
        unit_price: unitPrice,
        quantity: quantity,
        original_customer: customer,
        original_part_number: partNumber,
        monthly: monthly
      });
      
      openEditForecastPanel();
    }

    // Attach listeners when page loads
    document.addEventListener("DOMContentLoaded", function() {
      console.log("DOM loaded, attaching edit button listeners");
      attachEditButtonListeners();
    });

    // Also attach listeners after any AJAX content loads (if applicable)
    setTimeout(attachEditButtonListeners, 500);

    if (editForecastClose) editForecastClose.addEventListener("click", closeEditForecastPanel);
    if (editForecastCancel) editForecastCancel.addEventListener("click", closeEditForecastPanel);
    if (editForecastBackdrop) editForecastBackdrop.addEventListener("click", closeEditForecastPanel);
  </script>

</body>
</html>

